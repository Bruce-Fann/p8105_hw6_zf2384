---
title: "Homework 6"
author: "Zichen Fan"
date: "2025-11-27"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Problem 1 
```{r tide dataset}
library(readr)
library(tidyverse)
homicide = read_csv("data/homicide-data.csv")

homicide = homicide|>
  mutate(city_state = str_c(city, state, sep = ", "),
         solved = as.numeric(disposition == "Closed by arrest"),
         victim_age = as.numeric(victim_age)
  ) |> 
  filter(
    !city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"),
    victim_race %in% c("White", "Black")
  )
```

```{r mod1}
baltimore_df = 
  homicide |> 
  filter(city_state == "Baltimore, MD")

## Generalized Linear Model
fit_bt= 
  glm(solved ~ victim_age + victim_sex + victim_race, 
      data = baltimore_df, 
      family = binomial())


# conf.int = TRUE calculates confidence interval
# exponentiate = TRUE calculates Odds Ratio)
baltimore_results = 
  fit_bt |> 
  broom::tidy(conf.int = TRUE, exponentiate = TRUE)

# according to letter order, Female will be Reference group
baltimore_results |> 
  filter(term == "victim_sexMale") |> 
  select(term, OR = estimate, conf.low, conf.high) |> 
  knitr::kable(digits = 3)
```

```{r}
library(broom)

city_results = homicide|> 
  mutate(
        victim_sex = fct_relevel(factor(victim_sex), "Female") 
  )  |> 
  ## nest by city
  nest(data = -city_state) |> 
  mutate(
    # run glm to every line
    models = map(data, \(df) glm(solved ~ victim_age + victim_sex + victim_race, 
                                 data = df, 
                                 family = binomial())),
    # tidy and extract result
    results = map(models, \(mod) tidy(mod, conf.int = TRUE, exponentiate = TRUE))
  ) |> 
  select(city_state, results) |> 
  unnest(results) |> 
  filter(term == "victim_sexMale") |> 
  select(city_state, OR = estimate, conf.low, conf.high)

# arrange and check results 
city_results |> 
  arrange(OR) |> 
  knitr::kable(digits = 3)
```

```{r plot 1}

city_results |> 
  mutate(city_state = fct_reorder(city_state, OR)) |> 
  ggplot(aes(x = city_state, y = OR)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) + 
  geom_hline(yintercept = 1, color = "red", linetype = "dashed") +
   theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))+
  labs(
    title = "Odd ratio of male vs female of solved homiceide",
    x = "City",
    y = "Odds Ratio (OR)",
    ) 
```

Problem 2
```{r import data 2}
library(p8105.datasets)
library(modelr)
data("weather_df")
head(weather_df)

# Perform bootstrap analysis
boot_results = 
  weather_df |> 
  # 1. Generate 5000 bootstrap samples
  bootstrap(n = 5000) |> 
  
  # 2. Fit models and extract results for each sample
  mutate(
    # Fit linear regression: tmax ~ tmin + prcp
    models = map(strap, \(df) lm(tmax ~ tmin + prcp, data = df)),
    
    # Extract model statistics (for R-squared)
    results_glance = map(models, broom::glance),
    
    # Extract coefficients (for betas)
    results_tidy = map(models, broom::tidy)
  ) |> 
  
  # 3. Clean and calculate the specific quantities
  mutate(
    # Extract R-squared
    r_squared = map_dbl(results_glance, \(x) pull(x, r.squared)),
    
    # Calculate the product of Beta1 (tmin) and Beta2 (prcp)
    beta_ratio = map_dbl(results_tidy, \(df) {
      b1 = df |> filter(term == "tmin") |> pull(estimate)
      b2 = df |> filter(term == "prcp") |> pull(estimate)
      return(b1 / b2) 
    })
  ) |> 
  select(r_squared, beta_ratio)

```

```{r visualization}

# r square distribution
p1 = boot_results |> 
  ggplot(aes(x = r_squared)) +
  geom_density(fill = "skyblue", alpha = 0.6) + #  geom_histogram()
  labs(
    title = "Distribution of Estimated R-squared",
    x = "R Squared",
    y = "Density"
  ) +
  theme_minimal()

# Beta Quantity
p2 = boot_results |> 
  filter(is.finite(beta_ratio)) |> # 剔除可能的 Inf 值
  ggplot(aes(x = beta_ratio)) +
  geom_density(fill = "lightgreen", alpha = 0.6) +
  labs(
    title = "Distribution of Estimated Beta Quantity",
    x = "Value (beta1 / beta2)",
    y = "Density"
  ) +
  theme_minimal()


print(p1)
print(p2)

# calculate 95% CI
ci_r2 = quantile(boot_results$r_squared, probs = c(0.025, 0.975))
ci_beta = quantile(boot_results$beta_ratio, probs = c(0.025, 0.975), na.rm = TRUE)

list(ci_r_squared = ci_r2, ci_beta_ratio = ci_beta)
```

Problem 3
```{r}
birthweight <- read_csv("data/birthweight.csv")

 birthweight_clean <- birthweight |>
  mutate(
    babysex = as.factor(babysex),
    frace = as.factor(frace),
    mrace = as.factor(mrace),
    malform = as.factor(malform)
  ) |>
  drop_na()

glimpse(birthweight_clean)
sum(is.na(birthweight_clean))


```

```{r ,model}
my_model = lm(bwt ~ bhead + blength + babysex + gaweeks + smoken + wtgain, data = birthweight_clean)

summary(my_model)

birthweight_clean |>
  add_predictions(my_model) |>
  add_residuals(my_model) |>
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.5) +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Residuals vs Fitted Values (My Model)",
    x = "Fitted Values (Predicted Birthweight)",
    y = "Residuals"
  ) +
  theme_minimal()


```

```{r}

set.seed(123) #
cv_df <- crossv_mc(birthweight_clean, n = 100)

# 2.run RMSE
cv_results <- cv_df |>
  mutate(
    train = map(train, as_tibble),
    
    #  My Proposed Model
    model_my = map(train, \(df) lm(bwt ~ bhead + blength + babysex + gaweeks + smoken + wtgain, data = df)),
    
    # Length + Gestational Age (Main effects only)
    model_main = map(train, \(df) lm(bwt ~ blength + gaweeks, data = df)),
    
    # Head + Length + Sex + All Interactions
    model_inter = map(train, \(df) lm(bwt ~ bhead * blength * babysex, data = df))
  ) |>
  mutate(
    rmse_my    = map2_dbl(model_my, test, rmse),
    rmse_main  = map2_dbl(model_main, test, rmse),
    rmse_inter = map2_dbl(model_inter, test, rmse)
  )

# vis
cv_results |>
  select(starts_with("rmse")) |>
  pivot_longer(
    cols = everything(),
    names_to = "model",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) |>
  mutate(model = fct_reorder(model, rmse)) |> #
  ggplot(aes(x = model, y = rmse, fill = model)) +
  geom_violin() +
  labs(
    title = "Cross-validated Prediction Error (RMSE) Comparison",
    x = "Model",
    y = "RMSE"
  ) +
  theme_minimal()

# average RMSE values
cv_results |>
  select(starts_with("rmse")) |>
  summarise(across(everything(), mean))
```

